<Project>
  <!-- Common Cosmos kernel properties -->
  <PropertyGroup>
    <UsingCosmosSdk>true</UsingCosmosSdk>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <InvariantGlobalization>true</InvariantGlobalization>
    <SelfContained>true</SelfContained>
    <PublishTrimmed>true</PublishTrimmed>
    <IlcSystemModule>System.Private.CoreLib</IlcSystemModule>
  </PropertyGroup>

  <!-- ILC and build dependencies -->
  <PropertyGroup>
    <IlcDependsOn>RunPatcher;$(IlcDependsOn);PrepareForILLink</IlcDependsOn>
    <LinkTargetDependsOn>CompileWithIlc;BuildYasm;BuildGCC;$(LinkTargetDependsOn)</LinkTargetDependsOn>
  </PropertyGroup>

  <!-- Graphics settings -->
  <PropertyGroup>
    <UnRootGraphics Condition="$(UnRootGraphics) != 'true'">false</UnRootGraphics>
    <CosmosDefaultFont Condition="$(CosmosDefaultFont) == '' and $(UnRootGraphics) != 'true'">Cosmos.Kernel.Graphics.Fonts.DefaultFont.psf</CosmosDefaultFont>
  </PropertyGroup>

  <!-- Default kernel class name - inferred from RootNamespace or AssemblyName -->
  <PropertyGroup>
    <CosmosKernelClass Condition="'$(CosmosKernelClass)' == '' AND '$(RootNamespace)' != ''">$(RootNamespace).Kernel</CosmosKernelClass>
    <CosmosKernelClass Condition="'$(CosmosKernelClass)' == ''">$(AssemblyName).Kernel</CosmosKernelClass>
  </PropertyGroup>

  <!-- GCC compiler flags for x64 -->
  <PropertyGroup Condition="'$(DefineConstants)' != '' AND $(DefineConstants.Contains('ARCH_X64'))">
    <GCCCompilerFlags Condition="'$(GCCCompilerFlags)' == ''">-O2 -fno-stack-protector -fno-builtin -m64 -mcmodel=kernel -fno-PIC -ffreestanding -target x86_64-unknown-linux-gnu -nostdinc</GCCCompilerFlags>
  </PropertyGroup>

  <!-- GCC compiler flags for ARM64 -->
  <PropertyGroup Condition="'$(DefineConstants)' != '' AND $(DefineConstants.Contains('ARCH_ARM64'))">
    <GCCCompilerFlags Condition="'$(GCCCompilerFlags)' == ''">-O2 -fno-stack-protector -fno-builtin -ffreestanding -target aarch64-unknown-linux-gnu -nostdinc</GCCCompilerFlags>
  </PropertyGroup>

  <!-- ILC arguments -->
  <ItemGroup>
    <UnmanagedEntryPointsAssembly Include="Cosmos.Kernel.Core"/>
    <IlcArg Include="--feature:System.Diagnostics.Tracing.EventSource.IsSupported=false"/>
    <IlcArg Include="--generateunmanagedentrypoints:Cosmos.Kernel"/>
    <IlcArg Condition="$(UnRootGraphics) != 'true'" Include="--root:Cosmos.Kernel.Graphics"/>
    <RuntimeHostConfigurationOption Condition="$(CosmosDefaultFont) != ''" Include="Cosmos.Kernel.Graphics.Fonts.DefaultFont" Value="$(CosmosDefaultFont)"/>
  </ItemGroup>

  <!-- Plugs -->
  <ItemGroup>
    <PlugReference Include="Cosmos.Kernel.Plugs" />
  </ItemGroup>

  <!-- Ensure AOT Reference and ILCompiler are present in nuget cache -->
  <ItemGroup>
    <PackageDownload Include="Microsoft.NETCore.App.Runtime.NativeAOT.$(RuntimeIdentifier)"
                     Version="[$(BundledNETCoreAppPackageVersion)]"
                     Condition="'$(RuntimeIdentifier)' != ''" />
    <PackageDownload Include="runtime.$(RuntimeIdentifier).Microsoft.DotNet.ILCompiler"
                     Version="[$(BundledNETCoreAppPackageVersion)]"
                     Condition="'$(RuntimeIdentifier)' != ''" />
    <PackageDownload Include="Microsoft.NETCore.App.Ref"
             Version="[$(BundledNETCoreAppPackageVersion)]" />
  </ItemGroup>

  <!-- Build tools -->
  <ItemGroup>
    <PackageReference Include="Cosmos.Build.Common" />
    <PackageReference Include="Cosmos.Build.Ilc" />
    <PackageReference Include="Cosmos.Build.Asm" />
    <PackageReference Include="Cosmos.Build.Patcher" />
    <PackageReference Include="Cosmos.Build.GCC" />
  </ItemGroup>

  <!-- Architecture-specific packages for x64 -->
  <ItemGroup Condition="'$(DefineConstants)' != '' AND $(DefineConstants.Contains('ARCH_X64'))">
    <PackageReference Include="Cosmos.Kernel.Native.X64" />
  </ItemGroup>

  <!-- Architecture-specific packages for ARM64 -->
  <ItemGroup Condition="'$(DefineConstants)' != '' AND $(DefineConstants.Contains('ARCH_ARM64'))">
    <PackageReference Include="Cosmos.Kernel.Native.ARM64" />
  </ItemGroup>
</Project>
