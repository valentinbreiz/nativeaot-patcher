<Project>
  <Target Name="GetGCC" Condition="'$(OS)' != 'Windows_NT'">
    <PropertyGroup>
      <!-- Derive architecture -->
      <TargetArchitecture Condition="'$(RuntimeIdentifier)' != '' and '$(TargetArchitecture)' == ''">
        $([System.String]::Copy('$(RuntimeIdentifier)').Split('-')[1])
      </TargetArchitecture>
      <TargetArchitecture Condition="'$(TargetArchitecture)' == '' and '$(CosmosArch)' != ''">
        $(CosmosArch)
      </TargetArchitecture>

      <!-- x64 -->
      <GCCPath Condition="'$(TargetArchitecture)' == 'x64' and Exists('/opt/homebrew/bin/x86_64-elf-gcc')">
        /opt/homebrew/bin/x86_64-elf-gcc
      </GCCPath>
      <GCCPath Condition="'$(TargetArchitecture)' == 'x64' and '$(GCCPath)' == ''">
        gcc
      </GCCPath>

      <!-- arm64 -->
      <GCCPath Condition="'$(TargetArchitecture)' == 'arm64' and Exists('/opt/homebrew/bin/aarch64-elf-gcc')">
        /opt/homebrew/bin/aarch64-elf-gcc
      </GCCPath>
      <GCCPath Condition="'$(TargetArchitecture)' == 'arm64' and '$(GCCPath)' == '' and Exists('aarch64-elf-gcc')">
        aarch64-elf-gcc
      </GCCPath>
      <GCCPath Condition="'$(TargetArchitecture)' == 'arm64' and '$(GCCPath)' == '' and Exists('aarch64-linux-gnu-gcc')">
        aarch64-linux-gnu-gcc
      </GCCPath>

      <Error Condition="'$(TargetArchitecture)' == 'arm64' and '$(GCCPath)' == 'gcc'"
       Text="No ARM64 cross-compiler found. Install aarch64-elf-gcc or aarch64-linux-gnu-gcc." />
    </PropertyGroup>

    <Message Text="Using GCC for kernel compilation: $(GCCPath)" Importance="High" />
  </Target>
</Project>
