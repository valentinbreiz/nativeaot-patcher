<Project>

  <PropertyGroup>
    <!-- Windows only: default location of the global tool -->
    <CosmosPatcherExe Condition="'$(CosmosPatcherExe)' == ''">$(USERPROFILE)\.dotnet\tools\cosmos.patcher.exe</CosmosPatcherExe>
  </PropertyGroup>

  <Target Name="RunPatcher"
          AfterTargets="Build"
          DependsOnTargets="SetupPatcher"
          Condition="'$(EnablePatching)' == 'true'"
          Inputs="@(AssembliesToPatch->'%(Identity)')"
          Outputs="@(AssembliesToPatch->'%(PatcherOutputPath)')">

    <Message Importance="High"
             Text="Batch patching: %(AssembliesToPatch.Identity) -> %(AssembliesToPatch.PatcherOutputPath)" />

    <Message Text="▶ Running Patch…" Importance="High" />

    <Exec
      Command="&quot;$(CosmosPatcherExe)&quot; patch --target &quot;%(AssembliesToPatch.Identity)&quot; --output &quot;%(AssembliesToPatch.PatcherOutputPath)&quot; --plugs &quot;@(PlugRef-&gt;'%(Identity)', ';')&quot;"
      ConsoleToMSBuild="true"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="PatcherExitCode" />
      <Output TaskParameter="ConsoleOutput" PropertyName="PatcherConsoleOutput" />
    </Exec>

    <Error Condition="'$(PatcherExitCode)' != '0'"
           Text="Cosmos.Patcher failed for &quot;%(AssembliesToPatch.Identity)&quot; code=$(PatcherExitCode): $(PatcherConsoleOutput)" />

    <Message Importance="High"
             Text="✅ Cosmos.Patcher successfully patched: %(AssembliesToPatch.PatcherOutputPath)"
             Condition="'$(PatcherExitCode)' == '0' and Exists('%(AssembliesToPatch.PatcherOutputPath)')" />
    <Message Importance="High"
             Text="Cosmos.Patcher skipped (no plugs): %(AssembliesToPatch.Identity)"
             Condition="'$(PatcherExitCode)' == '0' and !Exists('%(AssembliesToPatch.PatcherOutputPath)')" />
  </Target>

</Project>
