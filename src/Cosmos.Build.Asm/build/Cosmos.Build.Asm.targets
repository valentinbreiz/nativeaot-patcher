<Project>
  <!-- Platform detection -->
  <PropertyGroup>
    <IsWindows Condition="'$(OS)' == 'Windows_NT'">true</IsWindows>
    <IsMacOS Condition="'$(OS)' != 'Windows_NT' AND $([MSBuild]::IsOSPlatform('OSX'))">true</IsMacOS>
    <IsLinux Condition="'$(OS)' != 'Windows_NT' AND '$(IsMacOS)' != 'true'">true</IsLinux>
  </PropertyGroup>

  <Import Project="Asm.Build.Unix.targets" Condition="'$(IsLinux)' == 'true'"/>
  <Import Project="Asm.Build.macOS.targets" Condition="'$(IsMacOS)' == 'true'"/>
  <Import Project="Asm.Build.Windows.targets" Condition="'$(IsWindows)' == 'true'"/>

  <Target Name="FindSourceFilesForYasm" AfterTargets="Build">
    <PropertyGroup>
      <TargetArchitecture Condition="$(RuntimeIdentifier) != ''">$(RuntimeIdentifier.Split('-')[1])</TargetArchitecture>
    </PropertyGroup>

    <!--
      NOTE: AsmSearchPath items are added by the Cosmos.Kernel.Native.X64.props / ARM64.props
      files when the NuGet package is imported. We don't add them here to avoid duplicates.
    -->

    <!-- Exclude Folders/Files that doesn't exists -->
    <ItemGroup>
      <NonExistentPaths Include="@(AsmSearchPath)" Condition="!Exists('%(FullPath)')" />
      <NonExistentFiles Include="@(AsmFiles)" Condition="!Exists('%(FullPath)')" />
      <AsmSearchPath Remove="@(NonExistentPaths)" />
      <AsmFiles Remove="@(NonExistentFiles)" />
    </ItemGroup>

    <Warning Text="Folder does not exists: %(NonExistentPaths.Identity)" Condition="@(NonExistentPaths) != ''" />
    <Warning Text="File does not exists: %(NonExistentFiles.Identity)" Condition="@(NonExistentFiles) != ''" />

    <!-- Override Folders For Architecture Specific Ones -->
    <ItemGroup Condition="'$(TargetArchitecture)' != ''">
      <AsmSearchPathWithArch Include="@(AsmSearchPath)" Condition="Exists('%(FullPath)/$(TargetArchitecture)/')" />
      <AsmSearchPath Remove="@(AsmSearchPathWithArch)"/>
      <AsmSearchPath Include="@(AsmSearchPathWithArch->'%(FullPath)/$(TargetArchitecture)/')"/>
    </ItemGroup>

    <PropertyGroup>
      <!-- Search for .asm files (YASM/NASM) for x64, .s files (GNU AS) for ARM64 -->
      <AsmSearchPattern Condition="'$(TargetArchitecture)' == 'x64' or '$(TargetArchitecture)' == ''">@(AsmSearchPath->'%(FullPath)/*.asm')</AsmSearchPattern>
      <AsmSearchPattern Condition="'$(TargetArchitecture)' == 'arm64'">@(AsmSearchPath->'%(FullPath)/*.s')</AsmSearchPattern>
    </PropertyGroup>

    <Message Text="⚙️  [ASM] TargetArchitecture: $(TargetArchitecture), CosmosArch: $(CosmosArch)" Importance="High" />
    <Message Text="⚙️  [ASM] Searching assembly files on: @(AsmSearchPath)" Importance="High" />
    <ItemGroup>
      <!-- Use the search pattern to find the .asm files -->
      <AsmSearch Include="$(AsmSearchPattern)" />
      <!-- Remove Duplicates -->
      <AsmSearch Remove="@(AsmFiles)" />
      <!-- Add Search Result -->
      <AsmFiles Include="@(AsmSearch)" />
    </ItemGroup>

    <Message Text="✅ [ASM] Number of Asm files found: @(AsmFiles->Count())" Importance="High" />
  </Target>

  <!-- Target that invokes the YasmBuildTask to compile assembly source files -->
  <Target Name="BuildYasm" AfterTargets="Build" DependsOnTargets="FindSourceFilesForYasm; GetYasm">
    <PropertyGroup>
      <!-- Yasm fallback paths - ONLY for x64 (yasm doesn't support ARM64) -->
      <YasmPath Condition="'$(TargetArchitecture)' != 'arm64' and $(YasmPath) == '' and Exists('/opt/homebrew/bin/yasm')">/opt/homebrew/bin/yasm</YasmPath>
      <YasmPath Condition="'$(TargetArchitecture)' != 'arm64' and $(YasmPath) == ''">/usr/bin/yasm</YasmPath>
      <!-- Adjust output path if needed -->
      <AsmOutputPath>$(IntermediateOutputPath)/cosmos/asm/</AsmOutputPath>
    </PropertyGroup>


    <!-- Invoke the custom Yasm task -->
    <YasmBuildTask
      YasmPath="$(YasmPath)"
      OutputPath="$(AsmOutputPath)"
      SourceFiles="@(AsmFiles)"
      TargetArchitecture="$(TargetArchitecture)" />

    <Message Text="✅ [ASM] Asm files compiled to: $(AsmOutputPath)" Importance="High" />
  </Target>

  <!-- Clean target to remove the asm folder -->
  <Target Name="CleanYasm" BeforeTargets="Clean">
    <PropertyGroup>
      <AsmOutputPath>$(IntermediateOutputPath)/cosmos/asm/</AsmOutputPath>
    </PropertyGroup>

    <RemoveDir Directories="$(AsmOutputPath)" />
  </Target>

</Project>
