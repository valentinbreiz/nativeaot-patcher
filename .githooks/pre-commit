#!/bin/sh
# Pre-commit hook to enforce code formatting using dotnet format on unstaged changes only.

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT" || exit 1

UNSTAGED_FILES=$(git diff --name-only --diff-filter=M)

if [ -z "$UNSTAGED_FILES" ]; then
    exit 0
fi

PROJECT_FILE=$(find . -name "*.csproj" -or -name "*.sln" | head -n 1)

if [ -z "$PROJECT_FILE" ]; then
    echo "Error: No .csproj or .sln file found. Cannot run dotnet format."
    exit 1
fi

echo "Running dotnet format check on unstaged files..."
dotnet format --verify-no-changes $PROJECT_FILE -- $UNSTAGED_FILES
RESULT=$?

if [ $RESULT -ne 0 ]; then
    echo "Error: Code formatting issues detected."
    echo "Please run 'dotnet format' to format your code before committing."
    exit 1
fi

exit 0
