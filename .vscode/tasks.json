{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Rebuild Libraries for x64",
      "type": "shell",
      "command": "bash",
      "args": [
        ".devcontainer/postCreateCommand.sh",
        "x64"
      ],
      "problemMatcher": [],
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Rebuild Libraries for ARM64",
      "type": "shell",
      "command": "bash",
      "args": [
        ".devcontainer/postCreateCommand.sh",
        "arm64"
      ],
      "problemMatcher": [],
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Build x64 DevKernel",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "publish",
        "examples/DevKernel/DevKernel.csproj",
        "-c", "Debug",
        "-r", "linux-x64",
        "-p:DefineConstants=ARCH_X64",
        "-p:CosmosArch=x64",
        "--verbosity", "minimal"
      ],
      "group": "build",
      "problemMatcher": ["$msCompile"],
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Build ARM64 DevKernel",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "publish",
        "examples/DevKernel/DevKernel.csproj",
        "-c", "Debug",
        "-r", "linux-arm64",
        "-p:DefineConstants=ARCH_ARM64",
        "-p:CosmosArch=arm64",
        "--verbosity", "minimal"
      ],
      "group": "build",
      "problemMatcher": ["$msCompile"],
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Debug x64 DevKernel",
      "dependsOn": ["Build x64 DevKernel"],
      "dependsOrder": "sequence",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "qemu-system-x86_64 -M q35 -cpu max -m 512M -serial stdio -cdrom ${workspaceFolder}/artifacts/bin/DevKernel/debug_linux-x64/cosmos/DevKernel.iso -display gtk -vga std -s -S -no-reboot -no-shutdown & sleep 1 && echo QEMU-DEVKERNEL-DEBUG-READY && wait"
      ],
      "isBackground": true,
      "problemMatcher": {
        "owner": "qemu-devkernel",
        "fileLocation": ["relative", "${workspaceFolder}"],
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^qemu",
          "endsPattern": "QEMU-DEVKERNEL-DEBUG-READY"
        },
        "pattern": { "regexp": ".*" }
      },
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Debug ARM64 DevKernel",
      "dependsOn": ["Build ARM64 DevKernel"],
      "dependsOrder": "sequence",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "qemu-system-aarch64 -M virt -cpu cortex-a53 -m 1G -bios /usr/share/AAVMF/AAVMF_CODE.fd -drive if=none,id=cd,file=${workspaceFolder}/artifacts/bin/DevKernel/debug_linux-arm64/cosmos/DevKernel.iso -device virtio-scsi-pci -device scsi-cd,drive=cd,bootindex=0 -device ramfb -display gtk,show-cursor=on -serial stdio -s -S & sleep 1 && echo QEMU-DEVKERNEL-ARM64-DEBUG-READY && wait"
      ],
      "isBackground": true,
      "problemMatcher": {
        "owner": "qemu-devkernel-arm64",
        "fileLocation": ["relative", "${workspaceFolder}"],
        "background": {
          "activeOnStart": true,
          "beginsPattern": "^qemu",
          "endsPattern": "QEMU-DEVKERNEL-ARM64-DEBUG-READY"
        },
        "pattern": { "regexp": ".*" }
      },
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Run QEMU x64 DevKernel",
      "type": "shell",
      "dependsOn": "Build x64 DevKernel",
      "command": "qemu-system-x86_64",
      "args": [
        "-M", "q35",
        "-cpu", "max",
        "-m", "512M",
        "-serial", "stdio",
        "-cdrom", "${workspaceFolder}/artifacts/bin/DevKernel/debug_linux-x64/cosmos/DevKernel.iso",
        "-display", "gtk",
        "-vga", "std",
        "-no-reboot",
        "-no-shutdown"
      ],
      "problemMatcher": [],
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Run QEMU ARM64 DevKernel",
      "type": "shell",
      "dependsOn": "Build ARM64 DevKernel",
      "command": "qemu-system-aarch64",
      "args": [
        "-M", "virt",
        "-cpu", "cortex-a53",
        "-m", "1G",
        "-bios", "/usr/share/AAVMF/AAVMF_CODE.fd",
        "-drive", "if=none,id=cd,file=${workspaceFolder}/artifacts/bin/DevKernel/debug_linux-arm64/cosmos/DevKernel.iso",
        "-device", "virtio-scsi-pci",
        "-device", "scsi-cd,drive=cd,bootindex=0",
        "-device", "ramfb",
        "-display", "gtk,show-cursor=on",
        "-serial", "stdio"
      ],
      "problemMatcher": [],
      "options": {
        "cwd": "${workspaceFolder}"
      }
    },
    {
      "label": "Stop QEMU x64",
      "type": "shell",
      "command": "pkill",
      "args": ["-f", "qemu-system-x86_64.*DevKernel"],
      "problemMatcher": [],
      "presentation": {
        "reveal": "never"
      }
    },
    {
      "label": "Stop QEMU ARM64",
      "type": "shell",
      "command": "pkill",
      "args": ["-f", "qemu-system-aarch64.*DevKernel"],
      "problemMatcher": [],
      "presentation": {
        "reveal": "never"
      }
    },
    {
      "label": "Build Test Runner",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "build",
        "${workspaceFolder}/tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj"
      ],
      "group": "build",
      "presentation": {
        "reveal": "always",
        "panel": "shared"
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Run Test: HelloWorld (x64)",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj",
        "--",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld",
        "x64",
        "60",
        "${workspaceFolder}/test-results.xml",
        "ci"
      ],
      "group": {
        "kind": "test",
        "isDefault": true
      },
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "clear": true
      },
      "problemMatcher": []
    },
    {
      "label": "Run Test: HelloWorld (x64, Console Only)",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj",
        "--",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld",
        "x64",
        "60"
      ],
      "group": "test",
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "clear": true
      },
      "problemMatcher": []
    },
    {
      "label": "Run Test: HelloWorld (ARM64)",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj",
        "--",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld",
        "arm64",
        "90",
        "${workspaceFolder}/test-results-arm64.xml",
        "ci"
      ],
      "group": "test",
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "clear": true
      },
      "problemMatcher": []
    },
    {
      "label": "Dev Test: HelloWorld (x64)",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "run",
        "--project",
        "${workspaceFolder}/tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj",
        "--",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld",
        "x64",
        "60",
        "-",
        "dev"
      ],
      "group": "test",
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "clear": true
      },
      "problemMatcher": []
    },
    {
      "label": "Build HelloWorld Test Kernel (x64)",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "publish",
        "-c",
        "Debug",
        "-r",
        "linux-x64",
        "-p:DefineConstants=ARCH_X64",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/Cosmos.Kernel.Tests.HelloWorld.csproj",
        "-o",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/output-x64"
      ],
      "group": "build",
      "presentation": {
        "reveal": "always",
        "panel": "shared"
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Build HelloWorld Test Kernel (ARM64)",
      "type": "shell",
      "command": "dotnet",
      "args": [
        "publish",
        "-c",
        "Debug",
        "-r",
        "linux-arm64",
        "-p:DefineConstants=ARCH_ARM64",
        "-p:CosmosArch=arm64",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/Cosmos.Kernel.Tests.HelloWorld.csproj",
        "-o",
        "${workspaceFolder}/tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/output-arm64"
      ],
      "group": "build",
      "presentation": {
        "reveal": "always",
        "panel": "shared"
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Clean Test Artifacts",
      "type": "shell",
      "command": "rm",
      "args": [
        "-f",
        "${workspaceFolder}/test-results*.xml",
        "${workspaceFolder}/uart-output.log"
      ],
      "presentation": {
        "reveal": "silent",
        "panel": "shared"
      }
    }
  ]
}