name: .NET Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "**" ]

jobs:
  patcher-tests:
    name: Run Cosmos.Tests.Patcher
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        dotnet-version: [ 10.0.x ]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ”„ Restore Dependencies
        run: dotnet restore ./tests/Cosmos.Tests.Patcher/Cosmos.Tests.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Patcher
        run: dotnet build ./src/Cosmos.Patcher/Cosmos.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Build.Patcher
        run: dotnet build ./src/Cosmos.Build.Patcher/Cosmos.Build.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Tests.Patcher
        run: dotnet build ./tests/Cosmos.Tests.Patcher/Cosmos.Tests.Patcher.csproj --configuration Debug --no-restore

      - name: ğŸš€ Run Tests
        run: dotnet test ./tests/Cosmos.Tests.Patcher/Cosmos.Tests.Patcher.csproj --no-build --configuration Debug --logger "trx;LogFileName=Cosmos.Tests.Patcher.trx"

      - name: ğŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: Cosmos.Tests.Patcher-Results
          path: ./tests/Cosmos.Tests.Patcher/TestResults/Cosmos.Tests.Patcher.trx

  scanner-tests:
    name: Run Cosmos.Tests.Scanner
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        dotnet-version: [ 10.0.x ]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ”„ Restore Dependencies
        run: dotnet restore ./tests/Cosmos.Tests.Scanner/Cosmos.Tests.Scanner.csproj

      - name: ğŸ”¨ Build Cosmos.Patcher
        run: dotnet build ./src/Cosmos.Patcher/Cosmos.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Build.Patcher
        run: dotnet build ./src/Cosmos.Build.Patcher/Cosmos.Build.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Tests.Scanner
        run: dotnet build ./tests/Cosmos.Tests.Scanner/Cosmos.Tests.Scanner.csproj --configuration Debug --no-restore

      - name: ğŸš€ Run Tests
        run: dotnet test ./tests/Cosmos.Tests.Scanner/Cosmos.Tests.Scanner.csproj --no-build --configuration Debug --logger "trx;LogFileName=Cosmos.Tests.Scanner.trx"

      - name: ğŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: Cosmos.Tests.Scanner-Results
          path: ./tests/Cosmos.Tests.Scanner/TestResults/Cosmos.Tests.Scanner.trx

  analyzer-tests:
    name: Run Cosmos.Tests.Build.Analyzer.Patcher
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        dotnet-version: [ 10.0.x ]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ”„ Restore Dependencies
        run: dotnet restore ./tests/Cosmos.Tests.Build.Analyzer.Patcher/Cosmos.Tests.Build.Analyzer.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Patcher.Analyzer.Tests
        run: dotnet build ./tests/Cosmos.Tests.Build.Analyzer.Patcher/Cosmos.Tests.Build.Analyzer.Patcher.csproj --configuration Debug --no-restore

      - name: ğŸš€ Run Tests
        run: dotnet test ./tests/Cosmos.Tests.Build.Analyzer.Patcher/Cosmos.Tests.Build.Analyzer.Patcher.csproj --no-build --configuration Debug --logger "trx;LogFileName=Cosmos.Tests.Build.Analyzer.Patcher.trx"

      - name: ğŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: Cosmos.Tests.Build.Analyzer.Patcher-Results
          path: ./tests/Cosmos.Tests.Build.Analyzer.Patcher/TestResults/Cosmos.Tests.Build.Analyzer.Patcher.trx

  asm-tests:
    name: Run Cosmos.Build.Asm.Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        dotnet-version: [ 10.0.x ]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ”— Install Linking Tools
        run: dotnet run --project src/Cosmos.Tools/Cosmos.Tools.csproj -- install -y -a x64 -t yasm

      - name: ğŸ”„ Restore Dependencies
        run: dotnet restore ./tests/Cosmos.Tests.Build.Asm/Cosmos.Tests.Build.Asm.csproj

      - name: ğŸ”¨ Build Cosmos.Patcher
        run: dotnet build ./src/Cosmos.Patcher/Cosmos.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Build.Patcher
        run: dotnet build ./src/Cosmos.Build.Patcher/Cosmos.Build.Patcher.csproj

      - name: ğŸ”¨ Build Cosmos.Build.Asm.Test
        run: dotnet build ./tests/Cosmos.Tests.Build.Asm/Cosmos.Tests.Build.Asm.csproj --configuration Debug --no-restore

      - name: ğŸš€ Run Tests
        run: dotnet test ./tests/Cosmos.Tests.Build.Asm/Cosmos.Tests.Build.Asm.csproj --no-build --configuration Debug --logger "trx;LogFileName=Cosmos.Tests.Build.Asm.trx"

      - name: ğŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: Cosmos.Build.Asm.Test-Results
          path: ./tests/Cosmos.Tests.Build.Asm/TestResults/Cosmos.Tests.Build.Asm.trx

  unix-iso-tests:
    name: Run ISO Build Tests - Unix (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        dotnet-version: [ 10.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
            assembler: yasm
          - arch: arm64
            rid: linux-arm64
            assembler: gcc-aarch64-linux-gnu
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ§¹ Clear NuGet cache before building packages
        run: dotnet nuget locals all --clear

      - name: ğŸ”„ Compile Packages (multi-arch)
        run: ./.devcontainer/postCreateCommand.sh

      - name: ğŸ”— Install Linking Tools
        run: dotnet run --project src/Cosmos.Tools/Cosmos.Tools.csproj -- install -y -a ${{ matrix.arch }}

      - name: ğŸ”§ Install ilc
        run: dotnet tool install -g ilc --add-source ./artifacts/package/release

      - name: Build ISO for ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ARCH_DEFINE="ARCH_ARM64"
          else
            ARCH_DEFINE="ARCH_X64"
          fi
          dotnet publish -c Debug -r ${{ matrix.rid }} -p:DefineConstants="$ARCH_DEFINE" --verbosity detailed ./examples/DevKernel/DevKernel.csproj -o ./output-${{ matrix.arch }}

      - name: ğŸ•µï¸â€â™‚ï¸ Verify Output
        run: |
          [ -f ./output-${{ matrix.arch }}/DevKernel.iso ] && echo "ISO exists for ${{ matrix.arch }}" || (echo "ISO missing for ${{ matrix.arch }}" && exit 1)

      - name: ğŸ“¤ Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: DevKernel-ISO-${{ matrix.arch }}-${{ github.job }}-${{ matrix.arch }}-${{ github.run_number }}
          path: ./output-${{ matrix.arch }}/DevKernel.iso

  windows-iso-tests:
    name: Run ISO Build Tests - Windows (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ windows-latest ]
        dotnet-version: [ 10.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
          - arch: arm64
            rid: linux-arm64
    steps:
      - name: ğŸ› ï¸ Enable long paths in Git
        run: git config --system core.longpaths true
        shell: pwsh

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ§¹ Clear NuGet cache before building packages
        run: dotnet nuget locals all --clear

      - name: ğŸ”„ Compile Packages (multi-arch)
        shell: pwsh
        run: ./.devcontainer/postCreateCommand.ps1

      - name: ğŸ”— Install Assembler & Linking Tools
        shell: pwsh
        run: dotnet run --project src/Cosmos.Tools/Cosmos.Tools.csproj -- install -y -a ${{ matrix.arch }}
          
      - name: ğŸ”§ Install ilc
        run: dotnet tool install -g ilc --add-source ./artifacts/package/release

      - name: Build ISO for ${{ matrix.arch }}
        shell: pwsh
        run: |
          if ("${{ matrix.arch }}" -eq "arm64") {
            $ARCH_DEFINE = "ARCH_ARM64"
          } else {
            $ARCH_DEFINE = "ARCH_X64"
          }
          dotnet publish -c Debug -r ${{ matrix.rid }} -p:DefineConstants=$ARCH_DEFINE --verbosity detailed ./examples/DevKernel/DevKernel.csproj -o ./output-${{ matrix.arch }}

      - name: ğŸ•µï¸â€â™‚ï¸ Verify Output
        shell: pwsh
        run: |
          if (Test-Path "./output-${{ matrix.arch }}/DevKernel.iso") {
              Write-Host "ISO exists for ${{ matrix.arch }}"
          } else {
              Write-Error "ISO missing for ${{ matrix.arch }}"
              exit 1
           }

      - name: ğŸ“¤ Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: DevKernel-ISO-${{ github.job }}-${{ matrix.arch }}-${{ github.run_number }}
          path: ./output-${{ matrix.arch }}/DevKernel.iso

  macos-iso-tests:
    name: Run ISO Build Tests - macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macos-latest ]
        dotnet-version: [ 10.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
            gcc_package: x86_64-elf-gcc
            binutils_package: x86_64-elf-binutils
          - arch: arm64
            rid: linux-arm64
            gcc_package: aarch64-elf-gcc
            binutils_package: aarch64-elf-binutils
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ› ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ğŸ§¹ Clear NuGet cache before building packages
        run: dotnet nuget locals all --clear

      - name: ğŸ”„ Compile Packages (multi-arch)
        run: ./.devcontainer/postCreateCommand.sh

      - name: ğŸ”— Install Linking Tools
        run: dotnet run --project src/Cosmos.Tools/Cosmos.Tools.csproj -- install -y -a ${{ matrix.arch }}

      - name: ğŸ”§ Install ilc
        run: dotnet tool install -g ilc --add-source ./artifacts/package/release

      - name: Build ISO for ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ARCH_DEFINE="ARCH_ARM64"
          else
            ARCH_DEFINE="ARCH_X64"
          fi
          dotnet publish -c Debug -r ${{ matrix.rid }} -p:DefineConstants="$ARCH_DEFINE" --verbosity detailed ./examples/DevKernel/DevKernel.csproj -o ./output-${{ matrix.arch }}

      - name: ğŸ•µï¸â€â™‚ï¸ Verify Output
        run: |
          [ -f ./output-${{ matrix.arch }}/DevKernel.iso ] && echo "ISO exists for ${{ matrix.arch }}" || (echo "ISO missing for ${{ matrix.arch }}" && exit 1)

      - name: ğŸ“¤ Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: DevKernel-ISO-macOS-${{ matrix.arch }}-${{ github.run_number }}
          path: ./output-${{ matrix.arch }}/DevKernel.iso
