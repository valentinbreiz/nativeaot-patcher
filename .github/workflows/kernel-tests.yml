name: Kernel Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/Cosmos.TestRunner.**'
      - 'tests/Kernels/**'
      - '.github/workflows/kernel-tests.yml'
  pull_request:
    branches: [ "**" ]
    paths:
      - 'src/**'
      - 'tests/Cosmos.TestRunner.**'
      - 'tests/Kernels/**'
      - '.github/workflows/kernel-tests.yml'
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Architecture to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - x64
          - arm64

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  helloworld-tests:
    name: HelloWorld Tests - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: [ 9.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
            qemu-package: qemu-system-x86
            timeout: 60
          - arch: arm64
            rid: linux-arm64
            qemu-package: qemu-system-arm
            qemu-firmware: qemu-efi-aarch64
            timeout: 90

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ðŸ—‘ï¸ Clear NuGet Cache
        run: dotnet nuget locals all --clear

      - name: ðŸ“¦ Build and Install Cosmos Packages (${{ matrix.arch }})
        run: ./.devcontainer/postCreateCommand.sh ${{ matrix.arch }}
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

      - name: ðŸ”§ Install QEMU and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.qemu-package }} xorriso lld
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y ${{ matrix.qemu-firmware }} gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          else
            sudo apt-get install -y yasm
          fi

      - name: ðŸ” Verify QEMU Installation
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            qemu-system-aarch64 --version
          else
            qemu-system-x86_64 --version
          fi

      - name: ðŸ”¨ Build Test Runner Engine
        run: dotnet build tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj -c Debug --verbosity normal

      - name: ðŸ§ª Run HelloWorld Kernel Tests
        id: run-tests
        run: |
          echo "Running HelloWorld kernel tests for ${{ matrix.arch }}..."
          dotnet run --project tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj \
            --no-build \
            -- tests/Kernels/Cosmos.Kernel.Tests.HelloWorld \
            ${{ matrix.arch }} \
            ${{ matrix.timeout }} \
            test-results-helloworld-${{ matrix.arch }}.xml \
            ci
        timeout-minutes: 5
        continue-on-error: false

      - name: ðŸ“Š Display Test Summary
        if: always()
        run: |
          if [ -f "test-results-helloworld-${{ matrix.arch }}.xml" ]; then
            echo "âœ… Test results file created"
            grep -o 'tests="[^"]*"' test-results-helloworld-${{ matrix.arch }}.xml || echo "Could not parse test count"
            grep -o 'failures="[^"]*"' test-results-helloworld-${{ matrix.arch }}.xml || echo "Could not parse failure count"
          else
            echo "âŒ Test results file not found"
          fi

      - name: ðŸ“Š Publish Test Results to PR
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: test-results-helloworld-${{ matrix.arch }}.xml
          check_name: HelloWorld Test Results (${{ matrix.arch }})
          comment_title: ðŸ§ª HelloWorld Tests (${{ matrix.arch }})
          comment_mode: always
          compare_to_earlier_commit: false

      - name: ðŸ“¤ Upload Test Results XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-helloworld-${{ matrix.arch }}-${{ github.run_number }}
          path: test-results-helloworld-${{ matrix.arch }}.xml
          retention-days: 30

      - name: ðŸ“¤ Upload UART Debug Log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uart-log-helloworld-${{ matrix.arch }}-${{ github.run_number }}
          path: uart-output.log
          retention-days: 7

      - name: ðŸ“¤ Upload Test Kernel ISO
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: HelloWorld-Test-ISO-${{ matrix.arch }}-${{ github.run_number }}
          path: |
            tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/output-${{ matrix.arch }}/*.iso
            tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/output-${{ matrix.arch }}/*.elf
          retention-days: 7

  memory-tests:
    name: Memory Tests - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: [ 9.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
            qemu-package: qemu-system-x86
            timeout: 120
          - arch: arm64
            rid: linux-arm64
            qemu-package: qemu-system-arm
            qemu-firmware: qemu-efi-aarch64
            timeout: 180

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ðŸ—‘ï¸ Clear NuGet Cache
        run: dotnet nuget locals all --clear

      - name: ðŸ“¦ Build and Install Cosmos Packages (${{ matrix.arch }})
        run: ./.devcontainer/postCreateCommand.sh ${{ matrix.arch }}
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

      - name: ðŸ”§ Install QEMU and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.qemu-package }} xorriso lld
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y ${{ matrix.qemu-firmware }} gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          else
            sudo apt-get install -y yasm
          fi

      - name: ðŸ” Verify QEMU Installation
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            qemu-system-aarch64 --version
          else
            qemu-system-x86_64 --version
          fi

      - name: ðŸ”¨ Build Test Runner Engine
        run: dotnet build tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj -c Debug --verbosity normal

      - name: ðŸ§ª Run Memory Kernel Tests
        id: run-tests
        run: |
          echo "Running Memory kernel tests for ${{ matrix.arch }}..."
          dotnet run --project tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj \
            --no-build \
            -- tests/Kernels/Cosmos.Kernel.Tests.Memory \
            ${{ matrix.arch }} \
            ${{ matrix.timeout }} \
            test-results-memory-${{ matrix.arch }}.xml \
            ci
        timeout-minutes: 10
        continue-on-error: false

      - name: ðŸ“Š Display Test Summary
        if: always()
        run: |
          if [ -f "test-results-memory-${{ matrix.arch }}.xml" ]; then
            echo "âœ… Test results file created"
            grep -o 'tests="[^"]*"' test-results-memory-${{ matrix.arch }}.xml || echo "Could not parse test count"
            grep -o 'failures="[^"]*"' test-results-memory-${{ matrix.arch }}.xml || echo "Could not parse failure count"
          else
            echo "âŒ Test results file not found"
          fi

      - name: ðŸ“Š Publish Test Results to PR
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: test-results-memory-${{ matrix.arch }}.xml
          check_name: Memory Test Results (${{ matrix.arch }})
          comment_title: ðŸ§ª Memory Tests (${{ matrix.arch }})
          comment_mode: always
          compare_to_earlier_commit: false

      - name: ðŸ“¤ Upload Test Results XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-memory-${{ matrix.arch }}-${{ github.run_number }}
          path: test-results-memory-${{ matrix.arch }}.xml
          retention-days: 30

      - name: ðŸ“¤ Upload UART Debug Log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uart-log-memory-${{ matrix.arch }}-${{ github.run_number }}
          path: uart-output.log
          retention-days: 7

      - name: ðŸ“¤ Upload Test Kernel ISO
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Memory-Test-ISO-${{ matrix.arch }}-${{ github.run_number }}
          path: |
            tests/Kernels/Cosmos.Kernel.Tests.Memory/output-${{ matrix.arch }}/*.iso
            tests/Kernels/Cosmos.Kernel.Tests.Memory/output-${{ matrix.arch }}/*.elf
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [helloworld-tests, memory-tests]
    if: always()
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸ§ª Kernel Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.helloworld-tests.result }}" == "success" ]; then
            echo "| HelloWorld | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| HelloWorld | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.memory-tests.result }}" == "success" ]; then
            echo "| Memory | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Memory | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
