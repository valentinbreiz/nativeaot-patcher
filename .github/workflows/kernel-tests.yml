name: Kernel Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/Cosmos.TestRunner.**'
      - 'tests/Kernels/**'
      - '.github/workflows/kernel-tests.yml'
  pull_request:
    branches: [ "**" ]
    paths:
      - 'src/**'
      - 'tests/Cosmos.TestRunner.**'
      - 'tests/Kernels/**'
      - '.github/workflows/kernel-tests.yml'
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Architecture to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - x64
          - arm64

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  helloworld-tests:
    name: HelloWorld Tests - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: [ 9.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
            qemu-package: qemu-system-x86
            timeout: 60
          - arch: arm64
            rid: linux-arm64
            qemu-package: qemu-system-arm
            qemu-firmware: qemu-efi-aarch64
            timeout: 90

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ðŸ—‘ï¸ Clear NuGet Cache
        run: dotnet nuget locals all --clear

      - name: ðŸ“¦ Build and Install Cosmos Packages (${{ matrix.arch }})
        run: ./.devcontainer/postCreateCommand.sh ${{ matrix.arch }}
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

      - name: ðŸ”§ Install QEMU and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.qemu-package }} xorriso lld
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y ${{ matrix.qemu-firmware }} gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          else
            sudo apt-get install -y yasm
          fi

      - name: ðŸ” Verify QEMU Installation
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            qemu-system-aarch64 --version
          else
            qemu-system-x86_64 --version
          fi

      - name: ðŸ”¨ Build Test Runner Engine
        run: dotnet build tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj -c Debug --verbosity normal

      - name: ðŸ§ª Run HelloWorld Kernel Tests
        id: run-tests
        run: |
          echo "Running HelloWorld kernel tests for ${{ matrix.arch }}..."
          dotnet run --project tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj \
            --no-build \
            -- tests/Kernels/Cosmos.Kernel.Tests.HelloWorld \
            ${{ matrix.arch }} \
            ${{ matrix.timeout }} \
            test-results-helloworld-${{ matrix.arch }}.xml \
            ci
        timeout-minutes: 5
        continue-on-error: false

      - name: ðŸ“¤ Upload Test Results XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-helloworld-${{ matrix.arch }}
          path: test-results-helloworld-${{ matrix.arch }}.xml
          retention-days: 30

      - name: ðŸ“¤ Upload UART Debug Log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uart-log-helloworld-${{ matrix.arch }}
          path: uart-output.log
          retention-days: 7

      - name: ðŸ“¤ Upload Test Kernel ISO
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: HelloWorld-Test-ISO-${{ matrix.arch }}
          path: |
            tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/output-${{ matrix.arch }}/*.iso
            tests/Kernels/Cosmos.Kernel.Tests.HelloWorld/output-${{ matrix.arch }}/*.elf
          retention-days: 7

  helloworld-results:
    name: HelloWorld Results
    runs-on: ubuntu-latest
    needs: helloworld-tests
    if: always()
    steps:
      - name: ðŸ“¥ Download x64 Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-helloworld-x64
          path: results-x64/
        continue-on-error: true

      - name: ðŸ“¥ Download arm64 Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-helloworld-arm64
          path: results-arm64/
        continue-on-error: true

      - name: ðŸ“Š Parse Test Results
        id: parse
        run: |
          parse_xml() {
            local file=$1
            if [ -f "$file" ]; then
              tests=$(grep -oP 'tests="\K[^"]+' "$file" | head -1)
              failures=$(grep -oP 'failures="\K[^"]+' "$file" | head -1)
              skipped=$(grep -oP 'skipped="\K[^"]+' "$file" | head -1)
              time=$(grep -oP 'time="\K[^"]+' "$file" | head -1)
              passed=$((tests - failures - skipped))
              if [ "$failures" = "0" ]; then
                status="âœ… Passed"
              else
                status="âŒ Failed"
              fi
              echo "$tests|$passed|$failures|$skipped|${time}s|$status"
            else
              echo "0|0|0|0|N/A|âš ï¸ No results"
            fi
          }

          x64_result=$(parse_xml "results-x64/test-results-helloworld-x64.xml")
          arm64_result=$(parse_xml "results-arm64/test-results-helloworld-arm64.xml")

          echo "x64_result=$x64_result" >> $GITHUB_OUTPUT
          echo "arm64_result=$arm64_result" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Post PR Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const x64 = '${{ steps.parse.outputs.x64_result }}'.split('|');
            const arm64 = '${{ steps.parse.outputs.arm64_result }}'.split('|');
            const runId = '${{ github.run_id }}';
            const repo = '${{ github.repository }}';
            const owner = context.repo.owner;
            const repoName = context.repo.repo;

            // Fetch artifacts for this run
            const { data: artifactsData } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo: repoName,
              run_id: runId,
            });

            const getArtifactUrl = (name) => {
              const artifact = artifactsData.artifacts.find(a => a.name === name);
              if (artifact) {
                return `https://github.com/${repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
              }
              return `https://github.com/${repo}/actions/runs/${runId}`;
            };

            const body = `## ðŸ§ª HelloWorld Tests

            | Architecture | Tests | Passed | Failed | Skipped | Duration | Status |
            |--------------|-------|--------|--------|---------|----------|--------|
            | x64 | ${x64[0]} | ${x64[1]} | ${x64[2]} | ${x64[3]} | ${x64[4]} | ${x64[5]} |
            | arm64 | ${arm64[0]} | ${arm64[1]} | ${arm64[2]} | ${arm64[3]} | ${arm64[4]} | ${arm64[5]} |

            ### ðŸ“Ž Artifacts
            | Architecture | Test Results | UART Log | Kernel ISO |
            |--------------|--------------|----------|------------|
            | x64 | [XML](${getArtifactUrl('test-results-helloworld-x64')}) | [Log](${getArtifactUrl('uart-log-helloworld-x64')}) | [ISO](${getArtifactUrl('HelloWorld-Test-ISO-x64')}) |
            | arm64 | [XML](${getArtifactUrl('test-results-helloworld-arm64')}) | [Log](${getArtifactUrl('uart-log-helloworld-arm64')}) | [ISO](${getArtifactUrl('HelloWorld-Test-ISO-arm64')}) |

            ðŸ“‹ [View full test summary](https://github.com/${repo}/actions/runs/${runId})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo: repoName,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c => c.body.includes('## ðŸ§ª HelloWorld Tests'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo: repoName,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo: repoName,
                issue_number: context.issue.number,
                body: body
              });
            }

  memory-tests:
    name: Memory Tests - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: [ 9.0.x ]
        arch: [ x64, arm64 ]
        include:
          - arch: x64
            rid: linux-x64
            qemu-package: qemu-system-x86
            timeout: 120
          - arch: arm64
            rid: linux-arm64
            qemu-package: qemu-system-arm
            qemu-firmware: qemu-efi-aarch64
            timeout: 180

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: ðŸ—‘ï¸ Clear NuGet Cache
        run: dotnet nuget locals all --clear

      - name: ðŸ“¦ Build and Install Cosmos Packages (${{ matrix.arch }})
        run: ./.devcontainer/postCreateCommand.sh ${{ matrix.arch }}
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

      - name: ðŸ”§ Install QEMU and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.qemu-package }} xorriso lld
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y ${{ matrix.qemu-firmware }} gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
          else
            sudo apt-get install -y yasm
          fi

      - name: ðŸ” Verify QEMU Installation
        run: |
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            qemu-system-aarch64 --version
          else
            qemu-system-x86_64 --version
          fi

      - name: ðŸ”¨ Build Test Runner Engine
        run: dotnet build tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj -c Debug --verbosity normal

      - name: ðŸ§ª Run Memory Kernel Tests
        id: run-tests
        run: |
          echo "Running Memory kernel tests for ${{ matrix.arch }}..."
          dotnet run --project tests/Cosmos.TestRunner.Engine/Cosmos.TestRunner.Engine.csproj \
            --no-build \
            -- tests/Kernels/Cosmos.Kernel.Tests.Memory \
            ${{ matrix.arch }} \
            ${{ matrix.timeout }} \
            test-results-memory-${{ matrix.arch }}.xml \
            ci
        timeout-minutes: 10
        continue-on-error: false

      - name: ðŸ“¤ Upload Test Results XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-memory-${{ matrix.arch }}
          path: test-results-memory-${{ matrix.arch }}.xml
          retention-days: 30

      - name: ðŸ“¤ Upload UART Debug Log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uart-log-memory-${{ matrix.arch }}
          path: uart-output.log
          retention-days: 7

      - name: ðŸ“¤ Upload Test Kernel ISO
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Memory-Test-ISO-${{ matrix.arch }}
          path: |
            tests/Kernels/Cosmos.Kernel.Tests.Memory/output-${{ matrix.arch }}/*.iso
            tests/Kernels/Cosmos.Kernel.Tests.Memory/output-${{ matrix.arch }}/*.elf
          retention-days: 7

  memory-results:
    name: Memory Results
    runs-on: ubuntu-latest
    needs: memory-tests
    if: always()
    steps:
      - name: ðŸ“¥ Download x64 Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-memory-x64
          path: results-x64/
        continue-on-error: true

      - name: ðŸ“¥ Download arm64 Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-memory-arm64
          path: results-arm64/
        continue-on-error: true

      - name: ðŸ“Š Parse Test Results
        id: parse
        run: |
          parse_xml() {
            local file=$1
            if [ -f "$file" ]; then
              tests=$(grep -oP 'tests="\K[^"]+' "$file" | head -1)
              failures=$(grep -oP 'failures="\K[^"]+' "$file" | head -1)
              skipped=$(grep -oP 'skipped="\K[^"]+' "$file" | head -1)
              time=$(grep -oP 'time="\K[^"]+' "$file" | head -1)
              passed=$((tests - failures - skipped))
              if [ "$failures" = "0" ]; then
                status="âœ… Passed"
              else
                status="âŒ Failed"
              fi
              echo "$tests|$passed|$failures|$skipped|${time}s|$status"
            else
              echo "0|0|0|0|N/A|âš ï¸ No results"
            fi
          }

          x64_result=$(parse_xml "results-x64/test-results-memory-x64.xml")
          arm64_result=$(parse_xml "results-arm64/test-results-memory-arm64.xml")

          echo "x64_result=$x64_result" >> $GITHUB_OUTPUT
          echo "arm64_result=$arm64_result" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Post PR Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const x64 = '${{ steps.parse.outputs.x64_result }}'.split('|');
            const arm64 = '${{ steps.parse.outputs.arm64_result }}'.split('|');
            const runId = '${{ github.run_id }}';
            const repo = '${{ github.repository }}';
            const owner = context.repo.owner;
            const repoName = context.repo.repo;

            // Fetch artifacts for this run
            const { data: artifactsData } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo: repoName,
              run_id: runId,
            });

            const getArtifactUrl = (name) => {
              const artifact = artifactsData.artifacts.find(a => a.name === name);
              if (artifact) {
                return `https://github.com/${repo}/actions/runs/${runId}/artifacts/${artifact.id}`;
              }
              return `https://github.com/${repo}/actions/runs/${runId}`;
            };

            const body = `## ðŸ§ª Memory Tests

            | Architecture | Tests | Passed | Failed | Skipped | Duration | Status |
            |--------------|-------|--------|--------|---------|----------|--------|
            | x64 | ${x64[0]} | ${x64[1]} | ${x64[2]} | ${x64[3]} | ${x64[4]} | ${x64[5]} |
            | arm64 | ${arm64[0]} | ${arm64[1]} | ${arm64[2]} | ${arm64[3]} | ${arm64[4]} | ${arm64[5]} |

            ### ðŸ“Ž Artifacts
            | Architecture | Test Results | UART Log | Kernel ISO |
            |--------------|--------------|----------|------------|
            | x64 | [XML](${getArtifactUrl('test-results-memory-x64')}) | [Log](${getArtifactUrl('uart-log-memory-x64')}) | [ISO](${getArtifactUrl('Memory-Test-ISO-x64')}) |
            | arm64 | [XML](${getArtifactUrl('test-results-memory-arm64')}) | [Log](${getArtifactUrl('uart-log-memory-arm64')}) | [ISO](${getArtifactUrl('Memory-Test-ISO-arm64')}) |

            ðŸ“‹ [View full test summary](https://github.com/${repo}/actions/runs/${runId})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo: repoName,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c => c.body.includes('## ðŸ§ª Memory Tests'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo: repoName,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo: repoName,
                issue_number: context.issue.number,
                body: body
              });
            }

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [helloworld-tests, memory-tests]
    if: always()
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸ§ª Kernel Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.helloworld-tests.result }}" == "success" ]; then
            echo "| HelloWorld | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| HelloWorld | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.memory-tests.result }}" == "success" ]; then
            echo "| Memory | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Memory | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
